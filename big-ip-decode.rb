#!/usr/bin/env ruby

#JoSko - 12.05.2016

=begin
Pull and decode F5 Big-IP Cookie

Feed me cookie, and I give you IP address... om.. nom.. nom..

Assumes HTTPS as I've never seen BIG-IP operate over HTTP.
=end

require 'net/https'


#Print help if no arguments supplied
if ARGV.empty?
	puts "./big-ip-decode.rb <HOST> <IP>"
	exit
else
	host = ARGV[0]
	port = ARGV[1]

	uri = URI("https://#{host}:#{port}/")

	http = Net::HTTP.new(host, port)
	http.use_ssl = true 
	http.verify_mode = OpenSSL::SSL::VERIFY_NONE
	request = Net::HTTP::Get.new(uri)
	response = http.request(request)

	cookie = /BIGipServer([^=]+)=([0-9]+)\.([0-9]+)\.[0-9]+/.match(response['Set-Cookie'])

	#Perform Bitwise AND operation and right shift
	octet1 = (cookie[2].to_i & 0x000000ff)
	octet2 = (cookie[2].to_i & 0x0000ffff) >> 8
	octet3 = (cookie[2].to_i & 0x00ffffff) >> 16
	octet4 = cookie[2].to_i >> 24

	port = (cookie[3].to_i & 0x00ff) * 256 + (cookie[3].to_i >> 8)

	puts "Cookie: #{cookie}"
	puts "Internal IP: #{octet1}.#{octet2}.#{octet3}.#{octet4}"
	puts "Port: #{port}"
end